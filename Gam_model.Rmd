---
title: "Gam"
author: "Sankhadip"
date: "5/2/2020"
output: html_document
---

```{r, eval=T, echo=FALSE}

#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
suppressMessages(library(tidyverse))
suppressMessages(library(ggplot2))
suppressMessages(library(GGally))
suppressMessages(library(lubridate))
suppressMessages(library(readxl))
suppressMessages(library(plotly))
suppressMessages(library(lubridate))
suppressMessages(library(sitar))
suppressMessages(library(plotly))
suppressMessages(library(dplyr))
suppressMessages(library(GGally))
suppressMessages(library(scatterplot3d))
suppressMessages(library(mgcv))
suppressMessages(library(cowplot))
suppressMessages(library(gganimate))
# installing the package devtools from CRAN:
#install.packages('devtools')
# load the package devtools:
suppressMessages(library(itsadug))
suppressMessages(library(mgcViz))
# install the newest version from itsadug:
#devtools::install_github("vr-vr/itsadug", build_vignettes=TRUE)

```

Reading the Data and Renaming the Variables.

```{r}
e <- read_excel("~/SharedFiles/ST606/2020/data/Exercise/fit_database_anthropometric_all.xlsx")

#Dealing with NAs
ena<-na.omit(e)

#Renaming Variables(Renaming Column Names for easy code handling and Cleaning Data)
names(ena)[names(ena)=='measurement date']<- 'measurement_date'
names(ena)[names(ena)=='age (years)']<- 'age_years'
names(ena)[names(ena)=='age bin']<- 'age_bin'
names(ena)[length(ena)]<-"z_cat_WHO"
names(ena)[9]<-"z_score_WHO"
names(ena)[6]<-"height_cm"
names(ena)[7]<-"weight_kg"

#Removing "NA" Characters
ena$observation <- 1:nrow(ena)
x<-ena[ena$z_cat_WHO=="NA",]
y<-x$observation
ena<-ena[-y,]

#Adding additional column
ena$year <- year(ena$measurement_date)
ena$ID <- as.factor(ena$ID)
#Changing Data Types
ena <- ena %>%
  mutate(gender = as.factor(gender),
         z_cat_WHO=as.factor(z_cat_WHO),
         measurement_date=as.Date(measurement_date),
         BMI = as.numeric(BMI),
         z_score_WHO=as.numeric(z_score_WHO),
         height_cm=as.numeric(height_cm),
         weight_kg=as.numeric(weight_kg))

```

Diving data as per Year

```{r}

ena_2007 <- filter(ena, year(measurement_date) == 2007)
ena_2008 <- filter(ena, year(measurement_date) == 2008)
ena_2009 <- filter(ena, year(measurement_date) == 2009)
ena_2010 <- filter(ena, year(measurement_date) == 2010)
ena_2011 <- filter(ena, year(measurement_date) == 2011)
ena_2012 <- filter(ena, year(measurement_date) == 2012)
ena_2013 <- filter(ena, year(measurement_date) == 2013)
ena_2014 <- filter(ena, year(measurement_date) == 2014)
ena_2015 <- filter(ena, year(measurement_date) == 2015)
ena_2016 <- filter(ena, year(measurement_date) == 2016)
ena_2017 <- filter(ena, year(measurement_date) == 2017)
ena_2018 <- filter(ena, year(measurement_date) == 2018)

```

Checking uniques IDs whose observation has been taken continuously from 2007 to 2018

```{r}
#kids data of 2007 whose obeservation were taken till the end of 2018 without any miss.
a_07_08 <- subset(ena_2007, ID %in% ena_2008$ID)
a_07_09 <- subset(a_07_08, ID %in% ena_2009$ID)
a_07_10 <- subset(a_07_09, ID %in% ena_2010$ID)
a_07_11 <- subset(a_07_10, ID %in% ena_2011$ID)
a_07_12 <- subset(a_07_11, ID %in% ena_2012$ID)
a_07_13 <- subset(a_07_12, ID %in% ena_2013$ID)
a_07_14 <- subset(a_07_13, ID %in% ena_2014$ID)
a_07_15 <- subset(a_07_14, ID %in% ena_2015$ID)
a_07_16 <- subset(a_07_15, ID %in% ena_2016$ID)
a_07_17 <- subset(a_07_16, ID %in% ena_2017$ID)
a_07_18 <- subset(a_07_17, ID %in% ena_2018$ID)

#All data of the a_07_18 dataset kids from 2007 to 2018.
a_unique_07<- subset(ena, ID %in% a_07_18$ID)

```

```{r}

#Checking prop increase per year
a_unique_07_pct<-a_unique_07 %>%
  group_by(ID) %>% 
  dplyr::arrange(measurement_date, .by_group = TRUE) %>%
  dplyr::mutate(pct_change_ht = (height_cm/lag(height_cm) - 1) * 100) %>% 
  dplyr::mutate(pct_change_wt = (weight_kg/lag(weight_kg) - 1) * 100) %>%
  dplyr::mutate(pct_change_bmi = (BMI/lag(BMI) - 1) * 100) %>%
  dplyr::select(ID, measurement_date, height_cm, BMI, weight_kg,pct_change_ht,pct_change_wt,pct_change_bmi,gender)

```


Weight Analysis

```{r}


a_unique_07$is_boy <- as.factor(ifelse(a_unique_07$gender=='boy', "1", "0"))
#Boys Weight
a_unique_07_boys <- filter(a_unique_07, gender=="boy")
b<-ggplot(a_unique_07_boys, aes(x=age_years, y=weight_kg, color=ID)) + geom_line() + theme(legend.position = "none") + ggtitle("Weight of all Boys ") +
  xlab("Age (Years)") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "bold"))+
  theme(strip.text = element_text(size=16))
  
#theme(strip.text.x = element_text(size = 15, color = "Black", face = "bold"))
ggplotly(b)

#Girls Weight
a_unique_07_girls <- filter(a_unique_07, gender=="girl")
g<-ggplot(a_unique_07_girls, aes(x=age_years, y=weight_kg, color=ID)) + geom_line() +
  theme(legend.position = "none")+ ggtitle("Weight of all Girls")+
  xlab("Age (Years)") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "bold"))+
  theme(strip.text = element_text(size=16))
ggplotly(g)

plot_grid(b,g)

#Comparing visually we can say that the weight increase rate is more in boys as compared to girls.

```


gam() or bam()

There are two functions for implementing a GAMM model: gam() and bam(). There are largely similar. The most important difference is that bam() is optimized for big data sets.

Smooths terms
To model a potentially nonlinear smooth or surface, three different smooth functions are available: * s() : for modeling a 1-dimensional smooth, or for modeling isotropic interactions (variables are measured in same units and on same scale)

te(): for modeling 2- or n-dimensional interaction surfaces of variables that are not isotropic (but see info about d parameter below). Includes ‘main’ effects.

ti(): for modeling 2- or n-dimensional interaction surfaces that do not include the ‘main effects’.

Parameters of smooth functions
The smooth functions have several parameters that could be set to change their behavior. The most often-used parameters are listed here:

k : number of ‘knots’. This parameter determines the upper bound of the number of underlying base functions being used to build up the curve. Thus, this parameter constraints the wigglyness of a smooth, or - as a metaphor - the number of bowpoints of a curve. Note that the model will base the number of base functions (reflected in the edf of the summary) on the data with the setting for k as upper bound. By default, the value of k for s() is around 9, and for te() and ti() 5 per dimension. Importantly, the value of k should be at most one less than the number of unique data points, otherwise it will fit the density of that predictor.

d : for specifiying that predictors in the interaction are on the same scale or dimension (only used in te() and ti()). For example, in te(Time, width, height, d=c(1,2)), with width and height reflecting the picture size measured in pixels, we specify that Time is on a different dimension than the next two variables. By default, the value would be d=c(1,1,1) in this case.

bs: specifies the type of underlying base functios. For s() this defaults to “tp” (thin plate regression spline) and for te() and ti() this defaults to “cr” (cubic regression spline). For random intercepts and linear random slopes use bs=“re”, but for random smooths use bs=“fs” (see below).

Setting up a GAMM model
Before the different components of a GAMM model were summarized. In this section we focus on finding the model that best fits the data.

We start with the full model. Note that we did not include interactions with the predictor Trial, because it is not the focus of our simulated experiment, and it takes much longer to run. Therefore, we only included Trial as random effect. We did not include Item effects, because these were not specified in this data set.

Random effects
Three different types of random effects are distinghuished when using GAMMs:

random intercepts adjust the height of other modelterms with a constant value: s(ID, bs=“re”).

random slopes adjust the slope of the trend of a numeric predictor: s(ID, age, bs=“re”).

random smooths adjust the trend of a numeric predictor in a nonlinear way: s(age, ID, bs=“fs”, m=1).

Notes:

Random intercepts and random slopes could be combined, but the random smooths already include random intercepts and random slope effects.

The argument m=1 sets a heavier penalty for the smooth moving away from 0, causing shrinkage to the mean.

Here we are using bam as gam takes longer time for huge datasets. Bam is a similar and an optimised version of gam for huge datasets.


No Random Effect

```{r}

#For Boys
model1_b <- bam(weight_kg ~ age_years
                + height_cm,
          data=a_unique_07_boys)
summary(model1_b)
gam.check(model1_b)

```

Random intercepts Effect

```{r}

model2_b <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re"),
          data=a_unique_07_boys)
#summary(model2_b)
model2_b_1<-getViz(model2_b)
print(plot(model2_b_1, allTerms = T), pages = 1)
gam.check(model2_b)

```
Random intercepts + slopes Effect

```{r}

model3_b <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re"),
          data=a_unique_07_boys)
#summary(model3_b)
model3_b_1<-getViz(model3_b)
print(plot(model3_b_1, allTerms = T), pages = 1)
plot(model3_b)
gam.check(model3_b)

```
Comparing Models

```{r}
library(itsadug)
compareML(model2_b,model3_b)

```

Random intercepts + slopes + smooths Effect

```{r}

model4_b <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re")
                + s(age_years, ID, bs="fs", m=1),
          data=a_unique_07_boys)
#summary(model4_b)

model4_b_1<-getViz(model4_b)
print(plot(model4_b_1, allTerms = T), pages = 1)
gam.check(model4_b)

#vis.gam(model4_b,theta=30,ticktype="detailed")
#vis.gam(model4_b,theta=-45,ticktype="detailed",se=2)
#vis.gam(model4_b,plot.type="contour")
plot(model4_b$fitted.values,model4_b$residuals)
plot(model4_b$fitted.values,model4_b$res)

```

```{r}
library(itsadug)
compareML(model3_b, model4_b)

```

We can conclude that Model 4 is best which explains boys weights.

Checking Auto Correlation Function

```{r}

par(mfrow=c(1,3), cex=1.1)
acf_resid(model2_b, split_pred="ID", main="ACF resid(model2)")
acf_resid(model3_b, split_pred="ID", main="ACF resid(model3)")
acf_resid(model4_b, split_pred="ID", main="ACF resid(model4)")

```


No Random Effect

```{r}
#For Girls
model1_g <- bam(weight_kg ~ age_years
                + height_cm,
          data=a_unique_07_girls)
summary(model1_g)
gam.check(model1_g)

```

Random intercepts Effect

```{r}
model2_g <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re"),
          data=a_unique_07_girls)
#summary(model2_g)
model2_g_1<-getViz(model2_g)
print(plot(model2_g_1, allTerms = T), pages = 1)
gam.check(model2_g)

```
Random intercepts + slopes Effect

```{r}

model3_g <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re"),
          data=a_unique_07_girls)
#summary(model3_b)
model3_g_1<-getViz(model3_g)
print(plot(model2_g_1, allTerms = T), pages = 1)
gam.check(model3_g)

```
Comparing Models

```{r}

compareML(model2_g,model3_g)

```

Random intercepts + slopes + smooths Effect

```{r}

model4_g <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re")
                + s(age_years, ID, bs="fs", m=1),
          data=a_unique_07_girls)
#summary(model4_b)
model4_g_1<-getViz(model4_g)
print(plot(model4_g_1, allTerms = T), pages = 1)

#vis.gam(model4_g,theta=30,ticktype="detailed")
#vis.gam(model4_g,theta=-45,ticktype="detailed",se=2)
#vis.gam(model4_g,plot.type="contour")

```

```{r}

compareML(model3_g, model4_g)

```

We can conclude that Model 4 is best which explains girls weights.

Checking Auto Correlation Function

```{r}

par(mfrow=c(1,3), cex=1.1)
acf_resid(model2_g, split_pred="ID", main="ACF resid(model2)")
acf_resid(model3_g, split_pred="ID", main="ACF resid(model3)")
acf_resid(model4_g, split_pred="ID", main="ACF resid(model4)")

```





```{r}

#Boys 
#Weight Prediction using the model 
a_unique_07_boys$pred_wt<-predict(model4_b,a_unique_07_boys, type='response')

#Comparing Actual and Predicted weight for Boys
b_act<-ggplot(a_unique_07_boys,aes(x=measurement_date, y=weight_kg, group=ID))+
  geom_line()+ggtitle("Actual Weights (Boys)")+ xlab("Measurement Date") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

b_pred<-ggplot(a_unique_07_boys,aes(x=measurement_date, y=pred_wt, group=ID))+
  geom_line()+ggtitle("Predicted Weights (Boys)")+ xlab("Measurement Date") +
  ylab("Predicted Weights (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

plot_grid(b_act,b_pred)

#Girls 
#Weight Prediction using the model 
a_unique_07_girls$pred_wt<-predict(model4_g,a_unique_07_girls, type='response')

#Comparing Actual and Predicted weight for Girls
g_act<-ggplot(a_unique_07_girls,aes(x=measurement_date, y=weight_kg, group=ID))+
  geom_line()+ggtitle("Actual Weights (Girls)") + xlab("Measurement Date") + ylab("Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

g_pred<-ggplot(a_unique_07_girls,aes(x=measurement_date, y=pred_wt, group=ID))+
  geom_line()+ggtitle("Predicted Weights (Girls)") + xlab("Measurement Date") + 
  ylab("Predicted Weights (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

plot_grid(g_act,g_pred)

```


```{r}

#Checking overall Actual and predicted for Boys

weight_mean_boy<-a_unique_07_boys %>% group_by(measurement_date) %>% 
  dplyr::summarise(wt_mean=mean(weight_kg),pred_wt_mean=mean(pred_wt))

boy<-ggplot(weight_mean_boy)+
  geom_line(aes(x=measurement_date,y=wt_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_wt_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))+
  ggtitle("Overall Weight Curve (Boys)") +
  xlab("Measurement Date") + ylab("Mean Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

#Checking overall Actual and predicted for Girls

weight_mean_girl<-a_unique_07_girls %>% group_by(measurement_date) %>% 
  dplyr::summarise(wt_mean=mean(weight_kg),pred_wt_mean=mean(pred_wt))

girl<-ggplot(weight_mean_girl)+
  geom_line(aes(x=measurement_date,y=wt_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_wt_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))+
  ggtitle("Overall Weight Curve (Girls)") +
  xlab("Measurement Date") + ylab("Mean Weight (Kg)") +
  theme(text = element_text(size=18,color = "Black", face = "plain"))+
  theme(strip.text = element_text(size=16))

#Comparing
par(mfrow=c(1,2), cex=.1)
plot_grid(boy, girl, labels = c("Weight of Boys","Weight of girl"))


```



BMI Analysis

```{r}
#Boys BMI
bmi_b<-ggplot(a_unique_07_boys, aes(x=age_years, y=BMI, color=ID)) + geom_line() +
  theme(legend.position = "none") + ggtitle("BMI of all Boys ")
ggplotly(bmi_b)

#Girls BMI
bmi_g<-ggplot(a_unique_07_girls, aes(x=age_years, y=BMI, color=ID)) + geom_line() +
    theme(legend.position = "none") + ggtitle("BMI of all Girls ")
ggplotly(bmi_g)

plot_grid(bmi_b, bmi_g)

```

```{r}
#Boys
model1_bmi_b <- bam(BMI ~ age_years,
          data=a_unique_07_boys)
summary(model1_bmi_b)
gam.check(model1_bmi_b)

```

Random intercepts Effect

```{r}
model2_bmi_b <- bam(BMI ~ age_years
          + s(ID, bs="re"),
          data=a_unique_07_boys)
#summary(model2_bmi_b)
model2_bmi_b_1<-getViz(model2_bmi_b)
print(plot(model2_bmi_b_1, allTerms = T), pages = 1)
gam.check(model2_bmi_b)

```

Random intercepts + slopes Effect

```{r}

model3_bmi_b <- bam(BMI ~ age_years
          + s(ID, bs="re")
          + s(ID, age_years, bs="re"),
          data=a_unique_07_boys)
#summary(model3_bmi_b)
model3_bmi_b_1<-getViz(model3_bmi_b)
print(plot(model3_bmi_b_1, allTerms = T), pages = 1)
gam.check(model3_bmi_b)

```

Comparing Models

```{r}

compareML(model2_bmi_b,model3_bmi_b)

```

Random intercepts + slopes + smooths Effect

```{r}

model4_bmi_b <- bam(BMI ~ age_years
          + s(ID, bs="re")
          + s(ID, age_years, bs="re")
          + s(age_years, ID, bs="fs", m=1),
          data=a_unique_07_boys)
#summary(model4_bmi_b)
model4_bmi_b_1<-getViz(model4_bmi_b)
print(plot(model4_bmi_b_1, allTerms = T), pages = 1)

```

Comparing Model3 and Model4

```{r}

compareML(model3_bmi_b, model4_bmi_b)

```

Checking Auto Correlation Function

```{r}

par(mfrow=c(1,3), cex=1.1)
acf_resid(model2_bmi_b, split_pred="ID", main="ACF resid(model2)")
acf_resid(model3_bmi_b, split_pred="ID", main="ACF resid(model3)")
acf_resid(model4_bmi_b, split_pred="ID", main="ACF resid(model4)")

```

```{r}
#Girls
model1_bmi_g <- bam(BMI ~ age_years,
          data=a_unique_07_girls)
summary(model1_bmi_g)
gam.check(model1_bmi_g)

```

Random intercepts Effect

```{r}

model2_bmi_g <- bam(BMI ~ age_years
          + s(ID, bs="re"),
          data=a_unique_07_girls)
#summary(model2_bmi_b)
model2_bmi_g_1<-getViz(model2_bmi_g)
print(plot(model2_bmi_g_1, allTerms = T), pages = 1)
gam.check(model2_bmi_g)

```
Random intercepts + slopes Effect

```{r}

model3_bmi_g <- bam(BMI ~ age_years
          + s(ID, bs="re")
          + s(ID, age_years, bs="re"),
          data=a_unique_07_girls)
#summary(model3_bmi_b)
model3_bmi_g_1<-getViz(model3_bmi_g)
print(plot(model3_bmi_g_1, allTerms = T), pages = 1)
gam.check(model3_bmi_g)

```
Comparing Models

```{r}

compareML(model2_bmi_g,model3_bmi_g)

```

Random intercepts + slopes + smooths Effect

```{r}

model4_bmi_g <- bam(BMI ~ age_years
          + s(ID, bs="re")
          + s(ID, age_years, bs="re")
          + s(age_years, ID, bs="fs", m=1),
          data=a_unique_07_girls)
#summary(model4_bmi_g)
model4_bmi_g_1<-getViz(model4_bmi_g)
print(plot(model4_bmi_g_1, allTerms = T), pages = 1)

```

```{r}

compareML(model3_bmi_g, model4_bmi_g)

```

Checking Auto Correlation Function

```{r}

par(mfrow=c(1,3), cex=1.1)
acf_resid(model2_bmi_g, split_pred="ID", main="ACF resid(model2)")
acf_resid(model3_bmi_g, split_pred="ID", main="ACF resid(model3)")
acf_resid(model4_bmi_g, split_pred="ID", main="ACF resid(model4)")

```


```{r}

#Boys 
#BMI Prediction using the model 
a_unique_07_boys$pred_bmi<-predict(model4_bmi_b,a_unique_07_boys, type='response')

#Comparing Actual and Predicted BMI for Boys
b_bmi_act<-ggplot(a_unique_07_boys,aes(x=measurement_date, y=BMI, group=ID))+
  geom_line()+ggtitle("Actual BMI (Boys)")

b_bmi_pred<-ggplot(a_unique_07_boys,aes(x=measurement_date, y=pred_bmi, group=ID))+
  geom_line()+ggtitle("Predicted BMI (Boys)")

plot_grid(b_bmi_act,b_bmi_pred)

#Girls 
#BMI Prediction using the model 
a_unique_07_girls$pred_bmi<-predict(model4_bmi_g,a_unique_07_girls, type='response')

#Comparing Actual and Predicted weight for Girls
g_bmi_act<-ggplot(a_unique_07_girls,aes(x=measurement_date, y=BMI, group=ID))+
  geom_line()+ggtitle("Actual BMI (Girls)")

g_bmi_pred<-ggplot(a_unique_07_girls,aes(x=measurement_date, y=pred_bmi, group=ID))+
  geom_line()+ggtitle("Predicted BMI (Girls)")

plot_grid(g_bmi_act,g_bmi_pred)

```


```{r}

#Checking overall Actual and Predicted BMI for boys

bmi_mean_boy<-a_unique_07_boys %>% group_by(measurement_date) %>% 
  dplyr::summarise(bmi_mean=mean(BMI),pred_bmi_mean=mean(pred_bmi))

boy_bmi<-ggplot(bmi_mean_boy)+
  geom_line(aes(x=measurement_date,y=bmi_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_bmi_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))

#Checking overall Actual and predicted for Girls

bmi_mean_girl<-a_unique_07_girls %>% group_by(measurement_date) %>% 
  dplyr::summarise(bmi_mean=mean(BMI),pred_bmi_mean=mean(pred_bmi))

girl_bmi<-ggplot(bmi_mean_girl)+
  geom_line(aes(x=measurement_date,y=bmi_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_bmi_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))

#Comparing
par(mfrow=c(1,2), cex=.1)
plot_grid(boy_bmi, girl_bmi, labels = c("BMI of Boys","BMI of girl"))


```



```{r}
#Lightweight and Least BMI kids in 2007 Analysis (Boys and Girls)

#Weight
weightl_07_boy <- a_07_18 %>% arrange(weight_kg) %>% filter((gender) %in% c("boy"))%>% head(5)
weightl_07_boy_IDs<-weightl_07_boy$ID

weightl_07_girl <- a_07_18 %>% arrange(weight_kg) %>% filter((gender) %in% c("girl")) %>% head(5)
weightl_07_girl_IDs<-weightl_07_girl$ID

#BMI
bmil_07_boy <- a_07_18 %>% arrange(BMI) %>% filter((gender) %in% c("boy"))%>% head(5)
bmil_07_boy_IDs<-bmil_07_boy$ID

bmil_07_girl <- a_07_18 %>% arrange(BMI) %>% filter((gender) %in% c("girl")) %>% head(5)
bmil_07_girl_IDs<-bmil_07_girl$ID

```


```{r}

#Checking weight rate of the lightest kids from 2007 throught 2018
#BOY
light_boys<-a_unique_07_pct %>% filter((ID) %in% weightl_07_boy_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_wt, pct_change_ht, pct_change_bmi,pct_change_ht)

ggplot(light_boys)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

#GIRL
light_girls<-a_unique_07_pct %>% filter((ID) %in% weightl_07_girl_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_wt, pct_change_bmi,pct_change_ht)

ggplot(light_girls)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

```

```{r}
#Checking BMI rate of the lowest BMI kids from 2007 throught 2018
#BOY
lowb_boys<-a_unique_07_pct %>% filter((ID) %in% bmil_07_boy_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_bmi,pct_change_ht,pct_change_wt)

ggplot(lowb_boys)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

#GIRL
lowb_girls<-a_unique_07_pct %>% filter((ID) %in% bmil_07_girl_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_bmi,pct_change_ht, pct_change_wt)

ggplot(lowb_girls)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

```


```{r}
#Heavyweight and High BMI kids in 2007 Analysis (Boys and Girls)

#Weight
weighth_07_boy <- a_07_18 %>% arrange(desc(weight_kg)) %>% filter((gender) %in% c("boy"))%>% head(5)
weighth_07_boy_IDs<-weighth_07_boy$ID

weighth_07_girl <- a_07_18 %>% arrange(desc(weight_kg)) %>% filter((gender) %in% c("girl")) %>% head(5)
weighth_07_girl_IDs<-weighth_07_girl$ID

#BMI
bmih_07_boy <- a_07_18 %>% arrange(desc(BMI)) %>% filter((gender) %in% c("boy"))%>% head(5)
bmih_07_boy_IDs<-bmil_07_boy$ID

bmih_07_girl <- a_07_18 %>% arrange(desc(BMI)) %>% filter((gender) %in% c("girl")) %>% head(5)
bmih_07_girl_IDs<-bmih_07_girl$ID

```


```{r}

#Checking Weight rate of the Heavy kids from 2007 throught 2018
#BOY
heavy_boys<-a_unique_07_pct %>% filter((ID) %in% weighth_07_boy_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_wt,pct_change_bmi,pct_change_ht)

ggplot(heavy_boys)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

#GIRL
heavy_girls<-a_unique_07_pct %>% filter((ID) %in% weighth_07_girl_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_wt,pct_change_bmi,pct_change_ht)

ggplot(heavy_girls)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

```


```{r}
#Checking BMI rate of the High BMI kids from 2007 throught 2018
#BOY
highb_boys<-a_unique_07_pct %>% filter((ID) %in% bmih_07_boy_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_bmi,pct_change_ht,pct_change_wt)

ggplot(highb_boys)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

#GIRL
highb_girls<-a_unique_07_pct %>% filter((ID) %in% bmih_07_girl_IDs) %>% 
  select(ID, measurement_date, weight_kg, pct_change_bmi,pct_change_ht,pct_change_wt)

ggplot(highb_girls)+
  geom_line(aes(x=measurement_date, y = pct_change_wt,col="% Weight Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_bmi,col="% BMI Change"))+
  geom_line(aes(x=measurement_date, y = pct_change_ht,col="% Height Change"))+
  facet_wrap(~ID)+
  geom_hline(yintercept=0, linetype="dashed", color = "red")

```


```{r}

en <- read_excel("~/SharedFiles/ST606/2020/data/Exercise/fit_database_exercise_normal.xlsx",na="NA")

#Dealing with NAs
en_na<-na.omit(en)

#Renaming Variables(Renaming Column Names for easy code handling and Cleaning Data)
names(en_na)[names(en_na)=='measurement date']<- 'measurement_date'
names(en_na)[names(en_na)=='age (years)']<- 'age_years'
names(en_na)[names(en_na)=='age bin']<- 'age_bin'
names(en_na)[length(en_na)]<-"DBP_10"
names(en_na)[9]<-"z_score_WHO"
names(en_na)[6]<-"height_cm"
names(en_na)[7]<-"weight_kg"
names(en_na)[10]<-"z_cat_WHO"
names(en_na)[11]<-"running_dist_m"
names(en_na)[12]<-"running_time_s"
names(en_na)[13]<-"running_speed"
names(en_na)[14]<-"pulse_0"
names(en_na)[15]<-"pulse_1"
names(en_na)[16]<-"pulse_5"
names(en_na)[17]<-"pulse_10"
names(en_na)[18]<-"SBP_0"
names(en_na)[19]<-"SBP_1"
names(en_na)[20]<-"SBP_5"
names(en_na)[21]<-"SBP_10"
names(en_na)[22]<-"DBP_0"
names(en_na)[23]<-"DBP_1"
names(en_na)[24]<-"DBP_5"

#Changing Data Types
en_na <- en_na %>%
  mutate(gender = as.factor(gender),
         z_cat_WHO=as.factor(z_cat_WHO),
         measurement_date=as.Date(measurement_date),
         BMI = as.numeric(BMI),
         z_score_WHO=as.numeric(z_score_WHO),
         height_cm=as.numeric(height_cm),
         weight_kg=as.numeric(weight_kg))

#Adding additional column
en_na$year <- year(en_na$measurement_date)
en_na$ID <- as.factor(en_na$ID)

```


```{r}
# Checking Pulse, SBP, DBP for boys and girls
Pulse<-ggplot(en_na)+
  geom_col(aes(y=pulse_10, x=age_bin ,fill=gender), position='dodge')+
  ggtitle("Pulse for Boys and Girls")

SBP<-ggplot(en_na)+
  geom_col(aes(y=SBP_10, x=age_bin,fill=gender), position='dodge') +
  ggtitle("SBP for Boys and Girls")

DBP<-ggplot(en_na)+
  geom_col(aes(y=DBP_10, x=age_bin,fill=gender), position='dodge') +
  ggtitle("DBP for Boys and Girls")

#Comparing
par(mfrow=c(1,3), cex=.1)
plot_grid(Pulse, SBP, DBP)

```

```{r}
#Grouping by ID, Gender and running distance
grp <- en_na %>% group_by(ID, gender, running_dist_m) %>% 
  dplyr::summarise(mean_SBP_0=mean(SBP_0),mean_SBP_1=mean(SBP_1),mean_SBP_5=mean(SBP_5),mean_SBP_10=mean(SBP_10),
                   mean_pulse_0=mean(pulse_0),mean_pulse_1=mean(pulse_1), mean_pulse_5=mean(pulse_5),
                   mean_pulse_10=mean(pulse_10), mean_DBP_0=mean(DBP_0), mean_DBP_1=mean(DBP_1),
                   mean_DBP_5=mean(DBP_5),mean_DBP_10=mean(DBP_10),
                   mean_running_speed=mean(running_speed))

#New dataset by mean
x<-grp %>%
  pivot_longer(mean_pulse_0:mean_pulse_10, names_to = "Pulse", values_to = "P_Count") %>%
  pivot_longer(mean_SBP_0:mean_SBP_10, names_to = "SBP", values_to = "SBP_Count") %>%
  pivot_longer(mean_DBP_0:mean_DBP_10, names_to = "DBP", values_to = "DBP_Count")

#Making factors and levelling
x$Pulse<-factor(x$Pulse,levels=c('mean_pulse_0','mean_pulse_1','mean_pulse_5','mean_pulse_10'))
x$SBP<-factor(x$SBP, levels = c('mean_SBP_0','mean_SBP_1','mean_SBP_5','mean_SBP_10'))
x$DBP<-factor(x$DBP,levels = c('mean_DBP_0','mean_DBP_1','mean_DBP_5','mean_DBP_10'))

P<-ggplot(x)+
  geom_col(aes(x=mean_running_speed, y=P_Count, fill=Pulse,color=Pulse),position='Dodge2')+
  facet_wrap(vars(gender, running_dist_m)) + transition_manual(Pulse,cumulative = TRUE)+
  theme(legend.text=element_text(size=15)) +
  theme(strip.text.x = element_text(size = 12, color = "Black", face = "bold")) +
  xlab("Mean Running Speed") +
  ylab("Pulse Count") +
  theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))
animate(P, fps=17)

```
```{r}
S<-ggplot(data=x)+
  geom_col(aes(x=mean_running_speed, y=SBP_Count, fill=SBP,color=SBP),position='Dodge')+
  facet_wrap(vars(gender, running_dist_m)) + transition_manual(SBP,cumulative = TRUE)+
  theme(legend.text=element_text(size=15)) +
  theme(strip.text.x = element_text(size = 12, color = "Black", face = "bold")) +
  xlab("Mean Running Speed") +
  ylab("SBP Count") +
  theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))
animate(S, fps=17)
```

```{r}

D<-ggplot(x)+
  geom_col(aes(x=mean_running_speed, y=DBP_Count, fill=DBP,color=DBP),position='Dodge2')+
  facet_wrap(vars(gender, running_dist_m)) + transition_manual(DBP,cumulative = TRUE) +
  theme(legend.text=element_text(size=15)) +
  theme(strip.text.x = element_text(size = 12, color = "Black", face = "bold")) +
  xlab("Mean Running Speed") +
  ylab("DBP Count") +
  theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold"))
animate(D, fps=17)
```


```{r}
#And Compare both shortest and tallest
#check weight and BMI and heartrate as well

```

```{r}
#Creating Training and Test dataset
set.seed(123)
#For Boys:
nb <- nrow(a_unique_07_boys)
trainingRowsb <- sample(nb, 0.75*nb)

#Model training data
training_b <- a_unique_07_boys[trainingRowsb, ]

#Test data
test_b <- a_unique_07_boys[-trainingRowsb, ]

#For Girls:
ng <- nrow(a_unique_07_girls)
trainingRowsg <- sample(ng, 0.75*ng)

#Model training data
training_g <- a_unique_07_girls[trainingRowsg, ]

#Test data
test_g <- a_unique_07_girls[-trainingRowsg, ]

```

```{r}
model3_b <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re"),
          data=training_b)

training_b$pred1<-predict(model3_b,training_b, type="response")
mean((training_b$weight_kg-training_b$pred1)^2)

test_b$pred1<-predict(model3_b,test_b, type="response")
mean((test_b$weight_kg-test_b$pred1)^2)

model4_b <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re")
                + s(age_years, ID, bs="fs", m=1),
          data=training_b)

training_b$pred2<-predict(model4_b,training_b, type="response")
mean((training_b$weight_kg-training_b$pred2)^2)

test_b$pred2<-predict(model4_b,test_b, type="response")
mean((test_b$weight_kg-test_b$pred2)^2)



model3_g <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re"),
          data=training_g)

training_g$pred1<-predict(model3_g,training_g, type="response")
mean((training_g$weight_kg-training_g$pred1)^2)

test_g$pred1<-predict(model3_g,test_g, type="response")
mean((test_g$weight_kg-test_g$pred1)^2)

model4_g <- bam(weight_kg ~ age_years
                + height_cm
                + s(ID, bs="re")
                + s(ID, age_years, bs="re")
                + s(age_years, ID, bs="fs", m=1),
          data=training_g)

training_g$pred2<-predict(model4_g,training_g, type="response")
mean((training_g$weight_kg-training_g$pred2)^2)

test_g$pred2<-predict(model4_g,test_g, type="response")
mean((test_g$weight_kg-test_g$pred2)^2)

```

```{r}
#Boys 

#Comparing Actual and Predicted weight for Boys
b_act<-ggplot(test_b,aes(x=measurement_date, y=weight_kg, group=ID))+
  geom_line()+ggtitle("Actual Weights (Boys)")

b_pred<-ggplot(test_b,aes(x=measurement_date, y=pred2, group=ID))+
  geom_line()+ggtitle("Predicted Weights (Boys)")

plot_grid(b_act,b_pred)

#Girls 

#Comparing Actual and Predicted weight for Girls
g_act<-ggplot(test_g,aes(x=measurement_date, y=weight_kg, group=ID))+
  geom_line()+ggtitle("Actual Weights (Girls)")

g_pred<-ggplot(test_g,aes(x=measurement_date, y=pred2, group=ID))+
  geom_line()+ggtitle("Predicted Weights (Girls)")

plot_grid(g_act,g_pred)

```


```{r}

#Checking overall Actual and predicted for Boys

weight_mean_boy<-a_unique_07_boys %>% group_by(measurement_date) %>% 
  dplyr::summarise(wt_mean=mean(weight_kg),pred_wt_mean=mean(pred_wt))

boy<-ggplot(weight_mean_boy)+
  geom_line(aes(x=measurement_date,y=wt_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_wt_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))

#Checking overall Actual and predicted for Girls

weight_mean_girl<-a_unique_07_girls %>% group_by(measurement_date) %>% 
  dplyr::summarise(wt_mean=mean(weight_kg),pred_wt_mean=mean(pred_wt))

girl<-ggplot(weight_mean_girl)+
  geom_line(aes(x=measurement_date,y=wt_mean,color='blue'))+
  geom_line(aes(x=measurement_date,y=pred_wt_mean,color='red'))+
  scale_color_discrete(name = "Legends", labels = c( "Predicted","Actual"))

#Comparing
par(mfrow=c(1,2), cex=.1)
plot_grid(boy, girl, labels = c("Weight of Boys","Weight of girl"))


plot(model4_b$fitted.values, model4_b$residuals)
plot(model4_b$fitted.values, model4_b$residuals,
main = "Residual Vs Fitted Values",
xlab = "Fitted Values",
ylab = "Residuals")

plot(a_unique_07_boys$weight_kg, a_unique_07_boys$pred_wt,
main = "Actual Vs Fitted Values",
xlab = "Fitted Values",
ylab = "Actual Values", cex.lab=1.3, cex.axis=1, cex.main=1.5, cex.sub=1.5)

plot(model4_b$fitted.values, model4_b$residuals,
main = "Residual Vs Fitted Values",
xlab = "Fitted Values",
ylab = "Residuals",cex.lab=1.3, cex.axis=1, cex.main=1.5, cex.sub=1.5)

```

```{r}
#Model fitting using only one ID

a <- bam(weight_kg ~ age_years
                + s(ID, bs="re"),
          data=training_b)

b <- bam(weight_kg ~ age_years
                + s(ID, bs="re")
                + s(ID, age_years, bs="re"),
          data=training_b)

c<- bam(weight_kg ~ age_years
                + s(ID, bs="re")
                + s(ID, age_years, bs="re")
                + s(age_years, ID, bs="fs", m=1),
          data=training_b)

#How model is fitting the Data
par(mfrow=c(2,2), cex=1.1)
v<-a_unique_07_boys %>% filter((ID) %in% c(132,310,313,182))
vp<-predict(a,v,type = "response")
ggplot(v, aes(x=age_years, y=weight_kg, color = ID))+ geom_point()+
  geom_line(aes(y=vp)) + theme(legend.position = "None") +
  facet_wrap(~ID) +theme(legend.position = "none")+ ggtitle("Random Intercept Effect")+
  xlab("Age (Years)") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=16,color = "Black", face = "bold"))+
  theme(strip.text = element_text(size=15))

w<-a_unique_07_boys %>% filter((ID) %in% c(132,310,313,182))
wp<-predict(b,w,type = "response")
ggplot(w, aes(x=age_years, y=weight_kg, color = ID))+ geom_point()+
  geom_line(aes(y=wp)) + facet_wrap(~ID) + theme(legend.position = "None") +
  ggtitle("Random Intercept & Slopes Effect")+
  xlab("Age (Years)") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=16,color = "Black", face = "bold"))+
  theme(strip.text = element_text(size=15))

z<-a_unique_07_boys %>% filter((ID) %in% c(132,310,313,182))
zp<-predict(c,z,type = "response")
ggplot(z, aes(x=age_years, y=weight_kg, color = ID))+ geom_point()+
  geom_line(aes(y=zp)) + facet_wrap(~ID) + theme(legend.position = "None") +
   ggtitle("Random Intercept, Slopes & Smooths Effect")+
  xlab("Age (Years)") +
  ylab("Weight (Kg)") +
  theme(text = element_text(size=16,color = "Black", face = "bold"))+
  theme(strip.text = element_text(size=15))


```


```{r}

#Findng All Participant whose Z-cat changes
ena_z<-ena%>%select(ID,z_cat_WHO)%>%distinct(ID,z_cat_WHO)%>%group_by(ID)%>%summarise(Count=n())%>%filter(Count!=1)

# Finding Participants whose z_cat changes (Data is throughout 2007-2018)
unique_z <- subset(ena_z, ID %in% a_07_18$ID)
nrow(unique_z)

#Same code like above
ena_z %>% filter((ID) %in% a_07_18$ID)
nrow(ena_z %>% filter((ID) %in% a_07_18$ID))

#All records for these IDs(Data is throughout 2007-2018)
unique_z_07<-a_unique_07 %>% filter((ID) %in% unique_z$ID)
nrow(unique_z_07)
```

```{r}

#Visualizing the Ids(Data is throughout 2007-2018)
ggplot(unique_z_07) +
  geom_line(aes(x=age_years, y= z_score_WHO, color = ID)) +
  geom_hline(yintercept=0.99999, linetype="dashed", color = "green")+
  geom_hline(yintercept=-2, linetype="dashed", color = "green")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -2, ymax = 0.99999, fill="green", alpha=0.15,      color = NA) + annotate(geom = "text", x=18, y=-0.5, label="Normal", color = " Black") +
  
  geom_hline(yintercept=-2.000001, linetype="dashed", color = "green")+
  geom_hline(yintercept=-3, linetype="dashed", color = "yellow")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -3, ymax = -1.99999, fill="yellow", alpha=0.3,   color = NA) + annotate(geom = "text", x=18, y=-2.5, label="Thin", color = " Black") +

  geom_hline(yintercept=-3.000001, linetype="dashed", color = "yellow")+
  geom_hline(yintercept=-Inf, linetype="dashed", color = "red")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin=-3.000001, ymax=-Inf,   fill="red", alpha=0.15,     color = NA) + annotate(geom = "text", x=18, y=-3.3, label="Severely Thin", color = " Black") +
  
  geom_hline(yintercept=1, linetype="dashed", color = "green")+
  geom_hline(yintercept=1.99999, linetype="dashed", color = "yellow")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 1, ymax = 1.99999, fill="yellow", alpha=0.3,     color = NA) + annotate(geom = "text", x=18, y=1.5, label="Overweight", color = " Black") +
  
  geom_hline(yintercept=2, linetype="dashed", color = "yellow")+
  geom_hline(yintercept=Inf, linetype="dashed", color = "red")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin=2, ymax=Inf, fill="red", alpha=0.15, color = NA) +
  annotate(geom = "text", x=18, y=2.5, label="Obese", color = " Black") +
  
  ggtitle("Changes in Weight and Category with Age")

#use horizontal lines to show the categories
#(z-score< −3 - severely thin, −3 < = z-score < −2 - thin,
#  −2<=z-score<1 - normal, 1<=z-score<2 - overweight, 2<=z-score - obese)
#unique_z_07[1:50,]

```

```{r}
#Rest all Ids
all_ids<-ena %>% filter(!(ID) %in% unique_z$ID)

#Visualizing the Ids(Data is not throughout 2007-2018)
ggplot(all_ids) +
  geom_line(aes(x=age_years, y= z_score_WHO, color = ID)) +
  geom_hline(yintercept=0.99999, linetype="dashed", color = "green")+
  geom_hline(yintercept=-2, linetype="dashed", color = "green")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -2, ymax = 0.99999, fill="green", alpha=0.15,      color = NA) + annotate(geom = "text", x=18, y=-0.5, label="Normal", color = " Black") +
  
  geom_hline(yintercept=-2.000001, linetype="dashed", color = "green")+
  geom_hline(yintercept=-3, linetype="dashed", color = "yellow")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -3, ymax = -1.99999, fill="yellow", alpha=0.3,   color = NA) + annotate(geom = "text", x=18, y=-2.5, label="Thin", color = " Black") +

  geom_hline(yintercept=-3.000001, linetype="dashed", color = "yellow")+
  geom_hline(yintercept=-Inf, linetype="dashed", color = "red")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin=-3.000001, ymax=-Inf,   fill="red", alpha=0.15,     color = NA) + annotate(geom = "text", x=18, y=-3.3, label="Severely Thin", color = " Black") +
  
  geom_hline(yintercept=1, linetype="dashed", color = "green")+
  geom_hline(yintercept=1.99999, linetype="dashed", color = "yellow")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 1, ymax = 1.99999, fill="yellow", alpha=0.3,     color = NA) + annotate(geom = "text", x=18, y=1.5, label="Overweight", color = " Black") +
  
  geom_hline(yintercept=2, linetype="dashed", color = "yellow")+
  geom_hline(yintercept=Inf, linetype="dashed", color = "red")+
  annotate("rect", xmin = -Inf, xmax = Inf, ymin=2, ymax=Inf, fill="red", alpha=0.15, color = NA) +
  annotate(geom = "text", x=18, y=2.5, label="Obese", color = " Black") +
  
  ggtitle("Changes in Weight and Category with Age")
  
```

```{r}

scale_fill_manual(values=c("red","orange","dark   green")) + 
  labs(size= "Nitrogen", x = "Employees of ACME Widgets",y = "Income in USD", title =   "ACME WIDGETS :: Employees Wise Sales Report-MAY 2014 ") + 
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = mean(Average), fill =   "blue", alpha = .1, color = NA)

ena[ena$ID==1,]

max(ena_z$Count)
z_cat_c<-ena[ena$ID %in% ena_z$ID,]
z_cat_c %>% filter((z_cat_WHO) %in% c("overweight"))
  
```

```{r}
ena_z<-a_unique_07%>%select(ID,z_cat_WHO)%>%distinct(ID,z_cat_WHO)%>%group_by(ID)%>%summarise(Count=n())%>%filter(Count!=1)
x[x$ID%in%c(1,2),]

```

